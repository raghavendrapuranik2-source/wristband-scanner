<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://unpkg.com/html5-qrcode"></script>
<style>
  body { font-family: Arial; text-align: center; }
  #reader { width: 320px; margin: auto; }
  button { padding:10px 15px; margin:6px; }
</style>
</head>

<body>

<h3>Wristband Distribution</h3>

<input id="volunteer" placeholder="Enter Volunteer Name"><br><br>

<div id="reader"></div>

<div id="card" hidden>
  <p><b>ID:</b> <span id="sid"></span></p>
  <p><b>Name:</b> <span id="name"></span></p>
  <button onclick="saveEntry()">Next</button>
  <button onclick="clearEntry()">Clear</button>
</div>

<br>
<button onclick="pushAll()">Push to Sheet</button>

<p id="count">Stored: 0</p>

<script>

const API = "https://script.google.com/macros/s/AKfycbx0toWkHIDhPvzs3cpjtM3cPuMYbIM_RFrxLoPU4IDdkuyoabeT6XSf1KRqbzN8Vm5CsA/exec";

let scanner;
let MASTER_MAP = {};
let currentEntry = null;
let entries = [];

/* =========================
   SAFE LOCAL STORAGE
========================= */
function saveLocalData() {
  localStorage.setItem("wristband_entries", JSON.stringify(entries));
}

function loadLocalData() {
  try {
    const data = localStorage.getItem("wristband_entries");
    if (data) {
      entries = JSON.parse(data);
      if (!Array.isArray(entries)) {
        entries = [];
      }
    } else {
      entries = [];
    }
  } catch (e) {
    console.log("Corrupted storage cleared");
    localStorage.removeItem("wristband_entries");
    entries = [];
  }
  updateCount();
}

function clearLocalData() {
  localStorage.removeItem("wristband_entries");
  entries = [];
  updateCount();
}

/* =========================
   API CALL
========================= */
function apiCall(action,data){
  const params = new URLSearchParams();
  params.append("action",action);
  for(let k in data){
    params.append(k,data[k]);
  }
  return fetch(API,{method:"POST",body:params})
    .then(r=>r.json());
}

/* =========================
   LOAD MASTER
========================= */
function loadMaster(){
  return apiCall("getMaster",{}).then(res=>{
    if(res.status==="OK"){
      MASTER_MAP = res.data;
    } else {
      alert("Failed to load master list");
    }
  });
}

/* =========================
   START SCANNER
========================= */
function startScanner(){

  document.getElementById("card").hidden = true;

  scanner = new Html5Qrcode("reader");

  Html5Qrcode.getCameras().then(devices => {

    if (!devices || devices.length === 0) {
      alert("No camera found");
      return;
    }

    let cameraId = devices[0].id;

    for (let d of devices) {
      if (d.label.toLowerCase().includes("back")) {
        cameraId = d.id;
        break;
      }
    }

    scanner.start(
      cameraId,
      { fps: 8, qrbox: { width: 220, height: 220 } },
      txt => stopScanner(()=>lookup(txt.trim())),
      err => {}
    );

  }).catch(err=>{
    alert("Camera error: " + err);
  });
}

function stopScanner(callback){
  if(!scanner){
    if(callback) callback();
    return;
  }
  scanner.stop().then(()=>{
    scanner.clear();
    scanner=null;
    if(callback) callback();
  });
}

/* =========================
   LOOKUP
========================= */
function lookup(id){

  if(!MASTER_MAP[id]){
    alert("Invalid ID");
    startScanner();
    return;
  }

  apiCall("checkReservation",{id}).then(res=>{

    if(res.status !== "CLEAR"){
      alert("Duplicate - already " + res.status);
      startScanner();
      return;
    }

    currentEntry = {
      id: id,
      name: MASTER_MAP[id],
      scanTime: new Date().toISOString()
    };

    document.getElementById("sid").innerText=id;
    document.getElementById("name").innerText=MASTER_MAP[id];
    document.getElementById("card").hidden=false;
  });
}

/* =========================
   SAVE ENTRY
========================= */
function saveEntry(){

  if(!currentEntry) return;

  apiCall("reserve",{
    id: currentEntry.id,
    device: navigator.userAgent
  })
  .then(res=>{

    if(res.status !== "OK"){
      alert("Duplicate - already " + res.status);
      currentEntry=null;
      startScanner();
      return;
    }

    entries.push(currentEntry);
    saveLocalData();

    currentEntry=null;
    updateCount();
    startScanner();
  });
}

function clearEntry(){
  currentEntry=null;
  startScanner();
}

/* =========================
   PUSH
========================= */
function pushAll(){

  const v=document.getElementById("volunteer").value.trim();

  if(!v){
    alert("Volunteer name required");
    return;
  }

  if(!entries.length){
    alert("No entries to push");
    return;
  }

  apiCall("push",{
    entries: JSON.stringify(entries),
    volunteer: v
  })
  .then(res=>{
    if(res.status==="OK"){
      alert(res.count + " pushed successfully");
      clearLocalData();
    } else {
      alert(res.message);
    }
  });
}

/* =========================
   UPDATE COUNT
========================= */
function updateCount(){
  document.getElementById("count").innerText =
    "Stored: " + entries.length;
}

/* =========================
   INIT
========================= */
window.onload = function(){
  loadLocalData();
  loadMaster().then(()=>{
    startScanner();
  });
};

</script>

</body>
</html>
