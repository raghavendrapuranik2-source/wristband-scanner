<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://unpkg.com/html5-qrcode"></script>
</head>
<body>

<h3>Wristband Distribution</h3>

<input id="volunteer" placeholder="Volunteer name"><br><br>
<div id="reader" style="width:320px;margin:auto;"></div>

<div id="card" hidden>
  <p><b>ID:</b> <span id="sid"></span></p>
  <p><b>Name:</b> <span id="name"></span></p>
  <button onclick="saveEntry()">Next</button>
  <button onclick="clearEntry()">Clear</button>
</div>

<br>
<button onclick="pushAll()">Push to Sheet</button>
<p id="count">Stored: 0</p>

<script>

const API="https://script.google.com/macros/s/AKfycbyi-1YFkJkFhr6avYIa4-ibJz3W3Tl8HF6t35CV-un_hVbe_Y4k2kC2pGA3A70XIGeaOA/exec";
let scanner;
let MASTER_MAP = {};
let currentEntry=null;
let entries=[];
let localIds=new Set();

/* ================= LOAD MASTER ON PAGE LOAD ================= */

function loadMaster(){
  return apiCall("getMaster",{}).then(res=>{
    if(res.status==="OK"){
      MASTER_MAP = res.data;
    }else{
      alert("Failed to load master list");
    }
  });
}

/* ================= API CALL ================= */

function apiCall(action,data){
  const params=new URLSearchParams();
  params.append("action",action);
  for(let k in data){
    params.append(k,data[k]);
  }
  return fetch(API,{method:"POST",body:params})
    .then(r=>r.json());
}

/* ================= SCANNER ================= */

function startScanner(){
  scanner=new Html5Qrcode("reader");
  scanner.start(
    {facingMode:"environment"},
    {fps:10,qrbox:250},
    txt=>stopScanner(()=>lookup(txt.trim())),
    ()=>{}
  );
}

function stopScanner(cb){
  if(!scanner)return cb();
  scanner.stop().then(()=>{scanner.clear();scanner=null;cb();});
}

/* ================= LOOKUP ================= */

function lookup(id){

  document.getElementById("sid").innerText="";
  document.getElementById("name").innerText="Checking...";
  document.getElementById("card").hidden=false;

  // 1️⃣ Check Master locally
  if(!MASTER_MAP[id]){
    alert("INVALID ID");
    startScanner();
    return;
  }

  // 2️⃣ Check reservation from server
  apiCall("checkReservation",{id}).then(res=>{

    if(res.status==="DUPLICATE"){
      alert("DUPLICATE");
      startScanner();
      return;
    }

    currentEntry={
      id:id,
      name:MASTER_MAP[id],
      scanTime:new Date().toISOString()
    };

    document.getElementById("sid").innerText=id;
    document.getElementById("name").innerText=MASTER_MAP[id];
  });
}

/* ================= NEXT ================= */

function saveEntry(){
  apiCall("reserve",{id:currentEntry.id,device:navigator.userAgent})
  .then(()=>{
    entries.push(currentEntry);
    localIds.add(currentEntry.id);
    currentEntry=null;
    document.getElementById("card").hidden=true;
    updateCount();
    startScanner();
  });
}

function clearEntry(){
  currentEntry=null;
  document.getElementById("card").hidden=true;
  startScanner();
}

function pushAll(){
  const v=document.getElementById("volunteer").value.trim();
  apiCall("push",{entries:JSON.stringify(entries),volunteer:v})
  .then(res=>{
    alert(res.count+" pushed");
    entries=[];
    localIds.clear();
    updateCount();
  });
}

function updateCount(){
  document.getElementById("count").innerText="Stored: "+entries.length;
}

/* ================= INIT ================= */

window.onload=()=>{
  loadMaster().then(()=>{
    startScanner();
  });
};

</script>
</body>
</html>



