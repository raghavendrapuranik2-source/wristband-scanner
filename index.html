<script>

const API = "https://script.google.com/macros/s/AKfycbx0toWkHIDhPvzs3cpjtM3cPuMYbIM_RFrxLoPU4IDdkuyoabeT6XSf1KRqbzN8Vm5CsA/exec";

let scanner;
let MASTER_MAP = {};
let currentEntry = null;
let entries = [];

/* =========================
   STORAGE HELPERS
========================= */
function saveLocalData() {
  localStorage.setItem("wristband_entries", JSON.stringify(entries));
}

function loadLocalData() {
  const data = localStorage.getItem("wristband_entries");
  if (data) {
    entries = JSON.parse(data);
  } else {
    entries = [];
  }
  updateCount();
}

function clearLocalData() {
  localStorage.removeItem("wristband_entries");
  entries = [];
  updateCount();
}

/* =========================
   API CALL
========================= */
function apiCall(action,data){
  const params = new URLSearchParams();
  params.append("action",action);
  for(let k in data){
    params.append(k,data[k]);
  }
  return fetch(API,{method:"POST",body:params})
    .then(r=>r.json());
}

/* =========================
   LOAD MASTER
========================= */
function loadMaster(){
  return apiCall("getMaster",{}).then(res=>{
    if(res.status==="OK"){
      MASTER_MAP = res.data;
    } else {
      alert("Master load failed");
    }
  });
}

/* =========================
   LOOKUP
========================= */
function lookup(id){

  if(!MASTER_MAP[id]){
    alert("Invalid ID");
    startScanner();
    return;
  }

  apiCall("checkReservation",{id}).then(res=>{

    if(res.status !== "CLEAR"){
      alert("Duplicate - already " + res.status);
      startScanner();
      return;
    }

    currentEntry = {
      id: id,
      name: MASTER_MAP[id],
      scanTime: new Date().toISOString()
    };

    document.getElementById("sid").innerText=id;
    document.getElementById("name").innerText=MASTER_MAP[id];
    document.getElementById("card").hidden=false;
  });
}

/* =========================
   SAVE ENTRY
========================= */
function saveEntry(){

  if(!currentEntry) return;

  apiCall("reserve",{
    id: currentEntry.id,
    device: navigator.userAgent
  })
  .then(res=>{

    if(res.status !== "OK"){
      alert("Duplicate - already " + res.status);
      currentEntry=null;
      document.getElementById("card").hidden=true;
      startScanner();
      return;
    }

    entries.push(currentEntry);
    saveLocalData(); // ğŸ”¥ persist immediately

    currentEntry=null;
    document.getElementById("card").hidden=true;
    updateCount();
    startScanner();
  });
}

/* =========================
   PUSH
========================= */
function pushAll(){

  const v=document.getElementById("volunteer").value.trim();

  if(!v){
    alert("Volunteer name required");
    return;
  }

  if(!entries.length){
    alert("No entries to push");
    return;
  }

  apiCall("push",{
    entries: JSON.stringify(entries),
    volunteer: v
  })
  .then(res=>{
    if(res.status==="OK"){
      alert(res.count + " pushed successfully");
      clearLocalData();  // ğŸ”¥ clear only after success
    } else {
      alert(res.message);
    }
  });
}

/* =========================
   COUNT
========================= */
function updateCount(){
  document.getElementById("count").innerText =
    "Stored: " + entries.length;
}

/* =========================
   INIT
========================= */
window.onload = function(){
  loadLocalData();   // ğŸ”¥ restore entries on refresh
  loadMaster().then(()=>{
    startScanner();
  });
};

</script>
