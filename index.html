<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://unpkg.com/html5-qrcode"></script>
</head>
<body>

<h3>Wristband Distribution</h3>

<input id="volunteer" placeholder="Volunteer name"><br><br>
<div id="reader" style="width:320px;margin:auto;"></div>

<div id="card" hidden>
  <p><b>ID:</b> <span id="sid"></span></p>
  <p><b>Name:</b> <span id="name"></span></p>
  <button onclick="saveEntry()">Next</button>
  <button onclick="clearEntry()">Clear</button>
</div>

<br>
<button onclick="pushAll()">Push to Sheet</button>
<p id="count">Stored: 0</p>

<script>

const API="https://script.google.com/macros/s/AKfycbx6iLnvuQIXfnYXDuqjkyPjkzok7DI8Fh1WavKQUPNJPpR2yA3kigUeyQuFxGg7wFWr6Q/exec";

let scanner,currentEntry=null,entries=[],localIds=new Set();

function apiCall(action,data){

  const params=new URLSearchParams();
  params.append("action",action);
  for(let k in data){
    params.append(k,
      typeof data[k]==="object"
      ? JSON.stringify(data[k])
      : data[k]);
  }

  return fetch(API,{method:"POST",body:params})
    .then(res=>res.text())
    .then(text=>{
      try{return JSON.parse(text);}
      catch{return {status:"ERROR",message:text};}
    });
}

function startScanner(){
  scanner=new Html5Qrcode("reader");
  scanner.start(
    {facingMode:"environment"},
    {fps:10,qrbox:250},
    txt=>stopScanner(()=>lookup(txt.trim())),
    ()=>{}
  );
}

function stopScanner(cb){
  if(!scanner)return cb();
  scanner.stop().then(()=>{scanner.clear();scanner=null;cb();});
}

function lookup(id){

  document.getElementById("sid").innerText="";
  document.getElementById("name").innerText="Loading...";
  document.getElementById("card").hidden=false;

  apiCall("lookup",{id}).then(res=>{

    if(res.status!=="OK"){
      alert(res.message||res.status);
      startScanner();
      return;
    }

    currentEntry={
      id:res.id,
      name:res.name,
      scanTime:new Date().toISOString()
    };

    document.getElementById("sid").innerText=res.id;
    document.getElementById("name").innerText=res.name;
  });
}

function saveEntry(){
  apiCall("reserve",{id:currentEntry.id,device:navigator.userAgent})
  .then(res=>{
    if(res.status!=="OK"){
      alert("Duplicate");
      startScanner();
      return;
    }
    entries.push(currentEntry);
    localIds.add(currentEntry.id);
    currentEntry=null;
    document.getElementById("card").hidden=true;
    updateCount();
    startScanner();
  });
}

function clearEntry(){
  currentEntry=null;
  document.getElementById("card").hidden=true;
  startScanner();
}

function pushAll(){
  const v=document.getElementById("volunteer").value.trim();
  apiCall("push",{entries,volunteer:v})
  .then(res=>{
    alert(res.count+" pushed");
    entries=[];
    localIds.clear();
    updateCount();
  });
}

function updateCount(){
  document.getElementById("count").innerText="Stored: "+entries.length;
}

window.onload=startScanner;

</script>
</body>
</html>






